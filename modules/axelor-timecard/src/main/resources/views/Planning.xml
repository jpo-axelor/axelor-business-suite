<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">

    <form name="planning-form" title="Planning" model="com.axelor.apps.timecard.db.Planning" width="large" canNew="false" canSave="false"
          onNew="action-planning-method-set-defaults"
          onLoad="action-planning-attrs-refresh-dashlets,action-planning-method-compute-monthly-wage">
        <menubar>
            <menu title="Tools" icon="fa-wrench">
                <item title="Preview" action="action-planning-method-preview" readonlyIf="(!project &amp;&amp; !employee) || !startDate || !endDate"/>
                <item title="Generate substitution lines" action="save,action-planning-view-open-substitution-wizard"/>
            </menu>
        </menubar>

        <panel>
            <field name="project" canEdit="false" domain="self.statusSelect = 2" onChange="action-planning-attrs-refresh-dashlets,action-planning-method-compute-monthly-wage" grid-view="project-grid" form-view="project-form"/>
            <field name="employee" canEdit="false" onChange="action-planning-attrs-refresh-dashlets,action-planning-method-compute-monthly-wage" grid-view="employee-grid" form-view="employee-form"/>
            <field name="startDate" validIf="startDate &lt; endDate" onChange="action-planning-attrs-refresh-dashlets,action-planning-method-compute-monthly-wage" colSpan="4"/>
            <field name="endDate" validIf="endDate &gt; startDate" onChange="action-planning-attrs-refresh-dashlets,action-planning-method-compute-monthly-wage" colSpan="4"/>
            <field name="monthlyWage" colSpan="4"/>
        </panel>

        <panel itemSpan="12" hidden="true" showIf="(project || employee) &amp;&amp; startDate &amp;&amp; endDate">
            <panel-dashlet name="planningLinesDashlet" title="Planning lines" action="action-planning-view-planning-lines-dashlet-both" hidden="true" showIf="project &amp;&amp; employee"/>
            <panel-dashlet name="planningLinesDashlet" title="Planning lines" action="action-planning-view-planning-lines-dashlet-project" hidden="true" showIf="project &amp;&amp; !employee"/>
            <panel-dashlet name="planningLinesDashlet" title="Planning lines" action="action-planning-view-planning-lines-dashlet-employee" hidden="true" showIf="!project &amp;&amp; employee"/>

            <button name="addPlanningLine" title="Add a planning line" css="btn-custom text-left" icon="fa-plus" onClick="save,action-planning-view-add-planning-line"/>
        </panel>

        <panel itemSpan="12" hidden="true" showIf="(project || employee) &amp;&amp; startDate &amp;&amp; endDate">
            <panel-dashlet name="timecardLinesDashlet" title="Scheduled timecard lines" action="action-planning-view-time-card-lines-dashlet-both" hidden="true" showIf="project &amp;&amp; employee"/>
            <panel-dashlet name="timecardLinesDashlet" title="Scheduled timecard lines" action="action-planning-view-time-card-lines-dashlet-project" hidden="true" showIf="project &amp;&amp; !employee"/>
            <panel-dashlet name="timecardLinesDashlet" title="Scheduled timecard lines" action="action-planning-view-time-card-lines-dashlet-employee" hidden="true" showIf="!project &amp;&amp; employee"/>

            <button name="addTimecardLine" title="Add a scheduled timecard line" css="btn-custom text-left" icon="fa-plus" onClick="save,action-planning-view-add-time-card-line"/>
        </panel>

        <panel itemSpan="12" hidden="true" showIf="(project || employee) &amp;&amp; startDate &amp;&amp; endDate">
            <panel-dashlet name="leaveRequestsDashlet" title="Leave requests" action="action-planning-view-leave-requests-dashlet-employee" hidden="true" showIf="(!project &amp;&amp; employee) || (project &amp;&amp; employee)"/>
            <panel-dashlet name="leaveRequestsDashlet" title="Leave requests" action="action-planning-view-leave-requests-dashlet-project" hidden="true" showIf="project &amp;&amp; !employee"/>
        </panel>
    </form>

    <action-method name="action-planning-method-set-defaults">
        <call class="com.axelor.apps.timecard.web.PlanningController" method="setDefaults"/>
    </action-method>

    <action-attrs name="action-planning-attrs-refresh-dashlets">
        <attribute for="planningLinesDashlet" name="refresh" expr="true"/>
        <attribute for="timecardLinesDashlet" name="refresh" expr="true"/>
        <attribute for="leaveRequestsDashlet" name="refresh" expr="true"/>
    </action-attrs>

    <action-method name="action-planning-method-compute-monthly-wage">
        <call class="com.axelor.apps.timecard.web.PlanningController" method="computeMonthlyWage"/>
    </action-method>

    <action-view name="action-planning-view-planning-lines-dashlet-both" title="Planning lines" model="com.axelor.apps.timecard.db.PlanningLine">
        <view type="grid" name="planning-line-grid"/>
        <view type="form" name="planning-line-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="show-toolbar" value="true"/>
        <domain>self.employee.id = :_employeeId AND self.project.id = :_projectId</domain>
        <context name="_employeeId" expr="eval: employee.id"/>
        <context name="_projectId" expr="eval: project.id"/>
    </action-view>

    <action-view name="action-planning-view-planning-lines-dashlet-project" title="Planning lines" model="com.axelor.apps.timecard.db.PlanningLine">
        <view type="grid" name="planning-line-grid"/>
        <view type="form" name="planning-line-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="show-toolbar" value="true"/>
        <domain>self.project.id = :_projectId</domain>
        <context name="_projectId" expr="eval: project.id"/>
    </action-view>

    <action-view name="action-planning-view-planning-lines-dashlet-employee" title="Planning lines" model="com.axelor.apps.timecard.db.PlanningLine">
        <view type="grid" name="planning-line-grid"/>
        <view type="form" name="planning-line-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="show-toolbar" value="true"/>
        <domain>self.employee.id = :_employeeId</domain>
        <context name="_employeeId" expr="eval: employee.id"/>
    </action-view>

    <action-view name="action-planning-view-add-planning-line" title="Planning line" model="com.axelor.apps.timecard.db.PlanningLine">
        <view type="form" name="planning-line-form"/>
        <view-param name="popup" value="reload"/>
        <context name="_projectId" expr="eval: project?.id"/>
        <context name="_employeeId" expr="eval: employee?.id"/>
    </action-view>

    <action-view name="action-planning-view-time-card-lines-dashlet-both" title="Scheduled timecard lines" model="com.axelor.apps.timecard.db.TimecardLine">
        <view type="grid" name="time-card-line-grid"/>
        <view type="form" name="time-card-line-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="show-toolbar" value="true"/>
        <domain>self.employee.id = :_employeeId AND self.project.id = :_projectId AND self.isDeletable = false AND (self.date BETWEEN :_startDate AND :_endDate)</domain>
        <context name="_employeeId" expr="eval: employee.id"/>
        <context name="_projectId" expr="eval: project.id"/>
        <context name="_startDate" expr="eval: startDate"/>
        <context name="_endDate" expr="eval: endDate"/>
    </action-view>

    <action-view name="action-planning-view-time-card-lines-dashlet-project" title="Scheduled timecard lines" model="com.axelor.apps.timecard.db.TimecardLine">
        <view type="grid" name="time-card-line-grid"/>
        <view type="form" name="time-card-line-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="show-toolbar" value="true"/>
        <domain>self.project.id = :_projectId AND self.isDeletable = false AND (self.date BETWEEN :_startDate AND :_endDate)</domain>
        <context name="_projectId" expr="eval: project.id"/>
        <context name="_startDate" expr="eval: startDate"/>
        <context name="_endDate" expr="eval: endDate"/>
    </action-view>

    <action-view name="action-planning-view-time-card-lines-dashlet-employee" title="Scheduled timecard lines" model="com.axelor.apps.timecard.db.TimecardLine">
        <view type="grid" name="time-card-line-grid"/>
        <view type="form" name="time-card-line-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="show-toolbar" value="true"/>
        <domain>self.employee.id = :_employeeId AND self.isDeletable = false AND (self.date BETWEEN :_startDate AND :_endDate)</domain>
        <context name="_employeeId" expr="eval: employee.id"/>
        <context name="_startDate" expr="eval: startDate"/>
        <context name="_endDate" expr="eval: endDate"/>
    </action-view>

    <action-view name="action-planning-view-add-time-card-line" title="Timecard line" model="com.axelor.apps.timecard.db.TimecardLine">
        <view type="form" name="time-card-line-form"/>
        <view-param name="popup" value="reload"/>
        <context name="_projectId" expr="eval: project?.id"/>
        <context name="_employeeId" expr="eval: employee?.id"/>
        <context name="_isForecastTCL" expr="eval: true"/>
    </action-view>

    <action-view name="action-planning-view-leave-requests-dashlet-employee" title="Leave requests" model="com.axelor.apps.hr.db.LeaveRequest">
        <view type="grid" name="leave-request-grid"/>
        <view type="form" name="leave-request-form"/>
        <view-param name="popup" value="true"/>
        <domain>self.user.employee.id = :_employeeId AND self.statusSelect = :_statusSelect AND (((:_startDate BETWEEN self.fromDate AND self.toDate) OR (:_endDate BETWEEN self.fromDate AND self.toDate)) OR ((self.fromDate BETWEEN :_startDate AND :_endDate) OR (self.toDate BETWEEN :_startDate AND :_endDate)))</domain>
        <context name="_employeeId" expr="eval: employee.id"/>
        <context name="_statusSelect" expr="eval: com.axelor.apps.hr.db.repo.LeaveRequestRepository.STATUS_VALIDATED"/>
        <context name="_startDate" expr="eval: startDate"/>
        <context name="_endDate" expr="eval: endDate"/>
    </action-view>

    <action-view name="action-planning-view-leave-requests-dashlet-project" title="Leave requests" model="com.axelor.apps.hr.db.LeaveRequest">
        <view type="grid" name="leave-request-grid"/>
        <view type="form" name="leave-request-form"/>
        <view-param name="popup" value="true"/>
        <domain>self.user.employee.id IN (:_employeeIds) AND self.statusSelect = :_statusSelect AND (((:_startDate BETWEEN self.fromDate AND self.toDate) OR (:_endDate BETWEEN self.fromDate AND self.toDate)) OR ((self.fromDate BETWEEN :_startDate AND :_endDate) OR (self.toDate BETWEEN :_startDate AND :_endDate)))</domain>
        <context name="_employeeIds" expr="eval: project.membersUserSet.collect([0], { it.employee.id })"/>
        <context name="_statusSelect" expr="eval: com.axelor.apps.hr.db.repo.LeaveRequestRepository.STATUS_VALIDATED"/>
        <context name="_startDate" expr="eval: startDate"/>
        <context name="_endDate" expr="eval: endDate"/>
    </action-view>

    <action-method name="action-planning-method-preview">
        <call class="com.axelor.apps.timecard.web.PlanningController" method="preview"/>
    </action-method>

    <action-view name="action-planning-view-open-substitution-wizard" title="Substitution assistant" model="com.axelor.apps.base.db.Wizard">
        <view type="form" name="time-card-line-substitution-wizard-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="popup-save" value="false"/>
        <view-param name="show-toolbar" value="false"/>
        <context name="_planningId" expr="eval: __self__.id"/>
    </action-view>

</object-views>
