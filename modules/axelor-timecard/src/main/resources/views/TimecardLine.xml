<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">

    <grid name="timecard-line-grid" title="Timecard lines" model="com.axelor.apps.timecard.db.TimecardLine" orderBy="startDateTime">
        <hilite if="typeSelect == 'absence' &amp;&amp; $number(totalSubstitutionHours) == 0" color="danger"/>
        <hilite if="typeSelect == 'absence' &amp;&amp; $number(totalSubstitutionHours) &lt; $number(duration)" color="warning"/>
        <field name="project" readonlyIf="typeSelect == 'contractual'"/>
        <field name="weekDay" readonlyIf="typeSelect == 'contractual'"/>
        <field name="date" readonlyIf="typeSelect == 'contractual'"/>
        <field name="startTime" readonlyIf="typeSelect == 'contractual'"/>
        <field name="endTime" readonlyIf="typeSelect == 'contractual'"/>
        <field name="typeSelect" readonlyIf="typeSelect == 'contractual'"/>

        <!-- TODO: change 'readonlyIf' to 'hideIf' (see ticket #13342) -->
        <button name="createAbsence" help="Create an absence for this line" icon="fa-user-times" readonlyIf="typeSelect != 'contractual'"
                onClick="save,com.axelor.apps.timecard.web.TimecardLineController:createAbsence"/>

        <!-- used for sorting -->
        <field name="startDateTime" hidden="true"/>
        <!-- used for hilite -->
        <field name="totalSubstitutionHours" hidden="true"/>
        <field name="duration" hidden="true"/>
    </grid>

    <form name="timecard-line-form" title="Timecard line" model="com.axelor.apps.timecard.db.TimecardLine" width="large"
          onNew="action-timecard-line-method-set-defaults,action-timecard-line-record-compute-duration,action-timecard-line-attrs-required-contractual-timecard-line"
          onLoad="action-timecard-line-record-update-durations,action-timecard-line-attrs-required-contractual-timecard-line"
          onSave="action-timecard-line-record-update-type-select">
        <panel>
            <field name="typeSelect" selection-in="['extra']" required="true" readonlyIf="['contractual', 'absence'].indexOf(typeSelect) &gt;= 0"/>
            <panel stacked="true">
                <button name="createAbsence" title="Create an absence for this line" icon="fa-user-times" showIf="typeSelect == 'contractual'" css="btn-custom"
                        onClick="save,com.axelor.apps.timecard.web.TimecardLineController:createAbsence"/>
                <field name="isContractual" showIf="typeSelect == 'extra' &amp;&amp; isSubstitution" onChange="action-timecard-line-attrs-type-select-readonly"/>
                <field name="contractualTimecardLine" showIf="typeSelect == 'absence'" readonlyIf="contractualTimecardLine"
                       onSelect="action-timecard-line-attrs-contractual-tcl-domain"/>
            </panel>

            <field name="project" domain="self.statusSelect = 2 AND self.isSite = true" canEdit="false" readonlyIf="typeSelect == 'contractual'"/>
            <panel stacked="true">
                <panel name="suggestionOffPanel">
                    <field name="employee" canEdit="false" required="true" readonlyIf="typeSelect == 'contractual'"
                           onChange="action-timecard-line-method-compute-night-hours"/>
                    <button name="suggestEmployeeBtn" title="Suggest employee" icon="fa-refresh" css="btn-custom" onClick="action-timecard-line-method-show-suggestions" showIf="isSubstitution &amp;&amp; !$readonly()"/>
                </panel>
                <panel name="suggestionOnPanel" hidden="true">
                    <field name="$employeeSuggestion" title="Employee suggestion" canEdit="false" widget="ManyToOne" target="com.axelor.apps.hr.db.Employee" onChange="action-timecard-line-attrs-set-employee-replacing,action-timecard-line-attrs-hide-suggestions"/>
                    <button name="cancelSuggestEmployeeBtn" title="Cancel" icon="fa-times" css="btn-custom" onClick="action-timecard-line-attrs-hide-suggestions"/>
                </panel>
            </panel>

            <field name="$employeeSuggestionList" title="Suggestions" widget="OneToMany" target="com.axelor.apps.timecard.db.EmployeeSuggestion" readonly="true" hidden="true" colSpan="12" grid-view="employee-suggestion-grid" form-view="employee-suggestion-form"/>

            <field name="activity" readonlyIf="typeSelect == 'contractual'"/>
            <spacer/>

            <panel readonlyIf="typeSelect == 'contractual'" colSpan="12">
                <field name="weekDay" colSpan="2"/>
                <field name="date" onChange="action-timecard-line-record-get-week-day" colSpan="2" required="true"/>
                <field name="startTime" colSpan="2" onChange="action-timecard-line-record-compute-duration,action-timecard-line-method-compute-night-hours" validIf="startTime &lt; endTime"/>
                <field name="endTime" colSpan="2" onChange="action-timecard-line-record-compute-duration,action-timecard-line-method-compute-night-hours" validIf="startTime &lt; endTime"/>
                <field name="duration" colSpan="2"/>
                <field name="durationNight" colSpan="2"/>
            </panel>

            <field name="leaveLine" title="Leave reason" canEdit="false" onSelect="action-timecard-line-attrs-leaveline-domain" hidden="true"
                   requiredIf="typeSelect == 'absence'" showIf="typeSelect == 'absence'" grid-view="leave-line-grid" form-view="leave-line-form"/>
            <field name="leaveRequest" showIf="leaveRequest &amp;&amp; typeSelect == 'absence'" grid-view="leave-request-grid" form-view="leave-request-form"/>

            <field name="comments" colSpan="12" widget="html"/>

            <panel title="Substitutions" showIf="isSubstitution || typeSelect == 'absence'" colSpan="12" readonlyIf="id == null || id &lt; 1">
                <field name="absenceTimecardLine" showIf="isSubstitution" grid-view="timecard-line-grid" form-view="timecard-line-form"/>
                <spacer/>
                <field name="totalSubstitutionHours" showIf="typeSelect == 'absence'"/>
                <panel-related field="substitutionTimecardLineList" onChange="action-timecard-line-record-update-durations" showIf="typeSelect == 'absence'" canNew="false" canEdit="false" colSpan="12" grid-view="timecard-line-grid" form-view="timecard-line-form"/>
                <button name="addSubstitution" title="Add a substitution" css="btn-custom text-left" icon="fa-plus" onClick="save,action-timecard-line-view-add-substitution" showIf="typeSelect == 'absence'"/>

                <field name="isSubstitution" hidden="true"/>
            </panel>
        </panel>
    </form>

    <form name="timecard-line-substitution-wizard-form" title="Substitution assistant" model="com.axelor.apps.base.db.Wizard"
          onNew="action-timecard-line-method-set-wizard-defaults">
        <panel>
            <field name="$startDate" title="Start date" widget="Date" colSpan="4"/>
            <field name="$endDate" title="End date" widget="Date" colSpan="4"/>
            <field name="$isContractual" title="Contractual" widget="Boolean" colSpan="4"/>
            <field name="$employeeToReplace" title="Employee to replace" widget="ManyToOne" target="com.axelor.apps.hr.db.Employee" readonly="true"/>
            <panel stacked="true">
                <panel name="suggestionOffPanel">
                    <field name="$employeeReplacing" title="Employee replacing" required="true" widget="ManyToOne" target="com.axelor.apps.hr.db.Employee" canEdit="false"/>
                    <button name="suggestEmployeeBtn" title="Suggest employee" icon="fa-exchange" css="btn-custom" onClick="action-timecard-line-method-show-suggestions"/>
                </panel>
                <panel name="suggestionOnPanel" hidden="true">
                    <field name="$employeeSuggestion" title="Employee suggestion" canEdit="false" widget="ManyToOne" target="com.axelor.apps.hr.db.Employee" onChange="action-timecard-line-attrs-set-employee-replacing,action-timecard-line-attrs-hide-suggestions"/>
                    <button name="cancelSuggestEmployeeBtn" title="Cancel" icon="fa-times" css="btn-custom" onClick="action-timecard-line-attrs-hide-suggestions"/>
                </panel>
            </panel>
            <field name="$employeeSuggestionList" title="Suggestions" widget="OneToMany" target="com.axelor.apps.timecard.db.EmployeeSuggestion" readonly="true" hidden="true" colSpan="12" grid-view="employee-suggestion-wizard-grid" form-view="employee-suggestion-wizard-form"/>
            <field name="$projects" title="Projects" required="true" widget="TagSelect" target="com.axelor.apps.project.db.Project" canEdit="false" canNew="false" colSpan="12"/>
            <button name="validate" title="Validate" readonlyIf="!$employeeReplacing || !$projects" onClick="action-timecard-line-method-generate-extra-tcl" colOffset="3"/>
        </panel>
    </form>

    <calendar name="timecard-line-calendar" title="Timecard" model="com.axelor.apps.timecard.db.TimecardLine"
              eventStart="startDateTime" eventStop="endDateTime" colorBy="typeSelect" editable="true">
        <field name="project"/>
        <field name="typeSelect"/>
    </calendar>

    <calendar name="timecard-line-leave-request-calendar" title="Leave requests" model="com.axelor.apps.timecard.db.TimecardLine"
              eventStart="startDateTime" eventStop="endDateTime" colorBy="typeSelect" editable="false">
        <field name="fullName"/>
        <field name="typeSelect"/>
    </calendar>

    <action-method name="action-timecard-line-method-set-defaults">
        <call class="com.axelor.apps.timecard.web.TimecardLineController" method="setDefaults"/>
    </action-method>

    <action-method name="action-timecard-line-method-set-wizard-defaults">
        <call class="com.axelor.apps.timecard.web.TimecardLineController" method="setWizardDefaults"/>
    </action-method>

    <action-method name="action-timecard-line-method-generate-extra-tcl">
        <call class="com.axelor.apps.timecard.web.TimecardLineController" method="generateExtraTCL"/>
    </action-method>

    <action-attrs name="action-timecard-line-attrs-leaveline-domain">
        <attribute for="leaveLine" name="domain" expr="eval: &quot; self.employee.id = ${__this__.employee?.id} &quot;"/>
    </action-attrs>

    <action-record name="action-timecard-line-record-compute-duration" model="com.axelor.apps.timecard.db.TimecardLine">
        <field name="duration" expr="eval: java.time.Duration.between(startTime, endTime).toMinutes() / 60" if="startTime != null &amp;&amp; endTime != null"/>
    </action-record>

    <action-method name="action-timecard-line-method-compute-night-hours">
        <call class="com.axelor.apps.timecard.web.TimecardLineController" method="computeNightHours"/>
    </action-method>

    <action-record name="action-timecard-line-record-get-week-day" model="com.axelor.apps.timecard.db.TimecardLine">
        <field name="weekDay" expr="eval: date.getDayOfWeek().getValue()"/>
    </action-record>

    <action-view name="action-timecard-line-view-add-substitution" title="Substitution line" model="com.axelor.apps.timecard.db.TimecardLine">
        <view type="form" name="timecard-line-form"/>
        <view-param name="popup" value="reload"/>
        <context name="_timecardLineId" expr="eval: id"/>
        <context name="_projectId" expr="eval: project?.id"/>
        <context name="_isSubstitution" expr="eval: true"/>
    </action-view>

    <action-record name="action-timecard-line-record-update-durations" model="com.axelor.apps.timecard.db.TimecardLine">
        <field name="totalSubstitutionHours" expr="eval: substitutionTimecardLineList.sum{ it.duration }"/>
    </action-record>

    <action-attrs name="action-timecard-line-attrs-type-select-readonly">
        <attribute for="typeSelect" name="readonly" expr="eval: isContractual"/>
    </action-attrs>

    <action-record name="action-timecard-line-record-update-type-select" model="com.axelor.apps.timecard.db.TimecardLine">
        <field name="typeSelect" expr="eval: com.axelor.apps.timecard.db.repo.TimecardLineRepository.TYPE_CONTRACTUAL" if="isContractual"/>
    </action-record>

    <action-method name="action-timecard-line-method-show-suggestions">
        <call class="com.axelor.apps.timecard.web.TimecardLineController" method="suggestEmployee"/>
    </action-method>

    <action-attrs name="action-timecard-line-attrs-hide-suggestions">
        <attribute for="suggestionOffPanel" name="hidden" expr="false"/>
        <attribute for="suggestionOnPanel" name="hidden" expr="true"/>
        <attribute for="$employeeSuggestionList" name="hidden" expr="true"/>
    </action-attrs>

    <action-attrs name="action-timecard-line-attrs-set-employee-replacing">
        <attribute for="employee" name="value" expr="eval: employeeSuggestion"/>
        <attribute for="$employeeReplacing" name="value" expr="eval: employeeSuggestion"/>
    </action-attrs>

    <action-attrs name="action-timecard-line-attrs-contractual-tcl-domain">
        <attribute for="contractualTimecardLine" name="domain" expr="eval: &quot;self.timecard.id = ${__parent__?.id} AND self.typeSelect = '${com.axelor.apps.timecard.db.repo.TimecardLineRepository.TYPE_CONTRACTUAL}' AND self.date = :date AND self.employee.id = ${employee?.id}&quot;"/>
    </action-attrs>

    <action-attrs name="action-timecard-line-attrs-required-contractual-timecard-line">
        <attribute for="contractualTimecardLine" name="required" expr="eval: typeSelect.equals(com.axelor.apps.timecard.db.repo.TimecardLineRepository.TYPE_ABSENCE) &amp;&amp; __parent__?._model.equals('com.axelor.apps.timecard.db.Timecard')"/>
    </action-attrs>

</object-views>
