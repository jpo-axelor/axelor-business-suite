<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">

    <grid name="timecard-grid" title="Real timecards" model="com.axelor.apps.timecard.db.Timecard">
        <field name="company"/>
        <field name="employee"/>
        <field name="period"/>
        <field name="statusSelect"/>
    </grid>

    <form name="timecard-form" title="Real timecard" model="com.axelor.apps.timecard.db.Timecard" width="large">
        <toolbar>
            <button name="showCalendarBtn" title="Show calendar" onClick="save,action-timecard-view-show-calendar"/>
        </toolbar>

        <menubar>
            <menu title="Tools" icon="fa-wrench">
                <item title="Compute hours" action="save,action-timecard-method-compute-hours"/>
                <item title="Generate timecard lines" action="save,action-timecard-method-generate-timecard-lines"/>
                <item title="Generate substitution lines" action="save,action-timecard-view-open-substitution-wizard" readonlyIf="!id"/>
            </menu>
        </menubar>

        <panel>
            <panel colSpan="12" readonlyIf="[3, 4, 5, 6].indexOf(statusSelect) &gt;= 0">
                <panel colSpan="12" showIf="id">
                    <field name="fullName" showTitle="false" css="label-bold bold large" colSpan="9"/>

                    <field name="$statusSelectTag" showTitle="false" readonly="true" colSpan="3">
                        <viewer>
                            <![CDATA[
                                <h4 class="text-right">
                                    <span class="label label-info" style="margin: 5px 0 !important; display: inline-table; line-height: initial;" ng-show="record.statusSelect == 1" x-translate>Draft</span>
                                    <span class="label label-warning" style="margin: 5px 0 !important; display: inline-table; line-height: initial;" ng-show="record.statusSelect == 2" x-translate>Awaiting validation</span>
                                    <span class="label label-success" style="margin: 5px 0 !important; display: inline-table; line-height: initial;" ng-show="record.statusSelect == 3" x-translate>Validated</span>
                                    <span class="label label-success" style="margin: 5px 0 !important; display: inline-table; line-height: initial;" ng-show="record.statusSelect == 4" x-translate>Closed</span>
                                    <span class="label label-important" style="margin: 5px 0 !important; display: inline-table; line-height: initial;" ng-show="record.statusSelect == 5" x-translate>Refused</span>
                                    <span class="label label-important" style="margin: 5px 0 !important; display: inline-table; line-height: initial;" ng-show="record.statusSelect == 6" x-translate>Canceled</span>
                                </h4>
                            ]]>
                        </viewer>
                    </field>
                </panel>

                <field name="company" colSpan="4" required="true" canEdit="false" grid-view="company-grid" form-view="company-form"/>
                <field name="employee" colSpan="4" required="true" canEdit="false" grid-view="employee-grid" form-view="employee-form"/>
                <field name="employee.mainEmploymentContract.monthlyHours" readonly="true" colSpan="4"/>

                <field name="period" required="true" canEdit="false" onChange="action-timecard-record-set-dates" domain="self.year.company = :company AND self.year.typeSelect = 2 AND self.statusSelect = 1" colSpan="4"/>
                <field name="fromDate" readonly="true" colSpan="4"/>
                <field name="toDate" readonly="true" colSpan="4"/>
            </panel>
        </panel>

        <panel showIf="groundForRefusal">
            <field name="groundForRefusal" css="red bold" readonly="true" colSpan="12">
                <viewer>
                    <![CDATA[
                        <h4>{{record.groundForRefusal}}</h4>
                    ]]>
                </viewer>
            </field>
        </panel>

        <panel-tabs>
            <panel-dashlet name="planningLinesDashlet" title="Planning lines" action="action-timecard-view-planning-lines-dashlet" showIf="employee" readonly="true"/>

            <panel title="Timecard lines">
                <panel-related field="timecardLineList" readonlyIf="[3, 4, 5, 6].indexOf(statusSelect) &gt;= 0" colSpan="12" grid-view="timecard-line-grid" form-view="timecard-line-form"/>

                <field name="payrollPreparationComment" colSpan="12"/>
            </panel>

            <panel-related field="weeklyHoursList" colSpan="12" readonly="true" readonlyIf="[3, 4, 5, 6].indexOf(statusSelect) &gt;= 0" canNew="false" canEdit="false" canRemove="false" grid-view="weekly-hours-grid" form-view="weekly-hours-form"/>
        </panel-tabs>

        <panel showIf="[3, 5].indexOf(statusSelect) &gt;= 0">
            <field name="validatedBy" showIf="statusSelect == 3"/>
            <field name="validationDate" showIf="statusSelect == 3"/>
            <field name="refusedBy" showIf="statusSelect == 5"/>
            <field name="refusalDate" showIf="statusSelect == 5"/>
        </panel>

        <panel colSpan="3" stacked="true" sidebar="true">
            <button name="sendBtn" title="Send" showIf="statusSelect == 1" onClick="action-timecard-record-send,save"/>
            <button name="validateBtn" title="Validate" showIf="statusSelect == 2" onClick="save,action-timecard-method-validate"/>
            <button name="refuseBtn" title="Refuse" showIf="statusSelect == 2" css="btn-danger" onClick="save,action-timecard-view-refuse"/>
            <button name="cancelBtn" title="Cancel" showIf="[2, 3].indexOf(statusSelect) &gt;= 0" onClick="action-timecard-record-cancel,save"/>
            <button name="closeBtn" title="Close" showIf="statusSelect == 3" onClick="action-timecard-record-close,save"/>
            <button name="draftBtn" title="Draft" showIf="[2, 5, 6].indexOf(statusSelect) &gt;= 0" onClick="action-timecard-record-draft,save"/>

            <!-- needed for tag and buttons -->
            <field name="statusSelect" hidden="true"/>
        </panel>

        <panel title="Characteristics" readonlyIf="[3, 4, 5, 6].indexOf(statusSelect) &gt;= 0" sidebar="true">
            <field name="complementaryHours" colSpan="6"/>
            <field name="complementOfHours" colSpan="6"/>
            <field name="supplementaryHours" colSpan="6"/>
            <field name="nightHours" colSpan="6"/>
        </panel>

        <panel-mail>
            <mail-messages limit="4"/>
            <mail-followers/>
        </panel-mail>
    </form>

    <form name="popup-timecard-refusal-form" title="Ground for refusal" model="com.axelor.apps.timecard.db.Timecard">
        <panel>
            <field name="groundForRefusal" showTitle="false" colSpan="12"/>
            <button name="refuseBtn" title="Refuse" onClick="save,action-timecard-method-refuse,close" readonlyIf="!groundForRefusal.length" colSpan="4" colOffset="4"/>
        </panel>
    </form>

    <action-view name="action-timecard-view-refuse" title="Ground for refusal" model="com.axelor.apps.timecard.db.Timecard">
        <view type="form" name="popup-timecard-refusal-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="popup-save" value="false"/>
        <view-param name="show-toolbar" value="false"/>
        <view-param name="show-confirm" value="false"/>
        <view-param name="forceEdit" value="true"/>
        <context name="_showRecord" expr="eval: id"/>
    </action-view>

    <action-method name="action-timecard-method-generate-timecard-lines">
        <call class="com.axelor.apps.timecard.web.TimecardController" method="generateTimecardLines"/>
    </action-method>

    <action-method name="action-timecard-method-compute-hours">
        <call class="com.axelor.apps.timecard.web.TimecardController" method="computeHours"/>
    </action-method>

    <action-view name="action-timecard-view-show-calendar" title="Timecard - ${employee.name}" model="com.axelor.apps.timecard.db.TimecardLine">
        <view type="calendar" name="timecard-line-calendar"/>
        <domain>self.timecard.id = :_id</domain>
        <context name="calendarDate" expr="eval: timecardLineList.sort{ it.date }[0]?.getDate()"/>
        <context name="_projectId" expr="eval: project?.id"/>
        <context name="_employeeId" expr="eval: employee?.id"/>
        <context name="_timecardId" expr="eval: id"/>
    </action-view>

    <action-view name="action-timecard-view-open-substitution-wizard" title="Substitution assistant" model="com.axelor.apps.base.db.Wizard">
        <view type="form" name="timecard-line-substitution-wizard-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="popup-save" value="false"/>
        <view-param name="show-toolbar" value="false"/>
        <view-param name="show-confirm" value="false"/>
        <context name="_timecardId" expr="eval: __self__.id"/>
    </action-view>

    <action-record name="action-timecard-record-draft" model="com.axelor.apps.timecard.db.Timecard">
        <field name="statusSelect" expr="eval: com.axelor.apps.timecard.db.repo.TimecardRepository.STATUS_DRAFT"/>
    </action-record>

    <action-record name="action-timecard-record-send" model="com.axelor.apps.timecard.db.Timecard">
        <field name="statusSelect" expr="eval: com.axelor.apps.timecard.db.repo.TimecardRepository.STATUS_AWAITING_VALIDATION"/>
    </action-record>

    <action-method name="action-timecard-method-validate">
        <call class="com.axelor.apps.timecard.web.TimecardController" method="validate"/>
    </action-method>

    <action-record name="action-timecard-record-close" model="com.axelor.apps.timecard.db.Timecard">
        <field name="statusSelect" expr="eval: com.axelor.apps.timecard.db.repo.TimecardRepository.STATUS_CLOSED"/>
    </action-record>
    
    <action-method name="action-timecard-method-refuse">
        <call class="com.axelor.apps.timecard.web.TimecardController" method="refuse"/>
    </action-method>

    <action-record name="action-timecard-record-cancel" model="com.axelor.apps.timecard.db.Timecard">
        <field name="statusSelect" expr="eval: com.axelor.apps.timecard.db.repo.TimecardRepository.STATUS_CANCELED"/>
    </action-record>

    <action-record name="action-timecard-record-set-dates" model="com.axelor.apps.timecard.db.Timecard">
        <field name="fromDate" expr="eval: period?.fromDate"/>
        <field name="toDate" expr="eval: period?.toDate"/>
    </action-record>

    <action-view name="action-timecard-view-planning-lines-dashlet" title="Planning lines" model="com.axelor.apps.timecard.db.PlanningLine">
        <view type="grid" name="planning-line-grid"/>
        <view type="form" name="planning-line-form"/>
        <view-param name="popup" value="true"/>
        <view-param name="show-toolbar" value="true"/>
        <domain>self.employee.id = :_employeeId</domain>
        <context name="_employeeId" expr="eval: employee.id"/>
    </action-view>

</object-views>
