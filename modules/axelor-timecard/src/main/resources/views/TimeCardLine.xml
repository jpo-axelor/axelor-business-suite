<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">

    <grid name="time-card-line-grid" title="Lignes de pointage" model="com.axelor.apps.timecard.db.TimeCardLine" orderBy="startDateTime">
        <field name="project" readonlyIf="typeSelect == 'contractual'"/>
        <field name="weekDay" readonlyIf="typeSelect == 'contractual'"/>
        <field name="date" readonlyIf="typeSelect == 'contractual'"/>
        <field name="startTime" readonlyIf="typeSelect == 'contractual'"/>
        <field name="endTime" readonlyIf="typeSelect == 'contractual'"/>
        <field name="typeSelect" readonlyIf="typeSelect == 'contractual'"/>

        <!-- used for sorting -->
        <field name="startDateTime" hidden="true"/>
    </grid>

    <form name="time-card-line-form" title="Ligne de pointage" model="com.axelor.apps.timecard.db.TimeCardLine" width="large"
          onNew="action-time-card-line-method-set-defaults,action-time-card-line-record-compute-duration">
        <panel readonlyIf="typeSelect == 'contractual'">
            <field name="typeSelect" selection-in="['extra', 'absence']" colSpan="12"/>
            <field name="project"/>
            <field name="employee"/>
            <field name="product"/>
            <spacer/>
            <field name="weekDay" colSpan="2"/>
            <field name="date" onChange="action-time-card-line-record-get-week-day" colSpan="2"/>
            <field name="startTime" colSpan="2" onChange="action-time-card-line-record-compute-duration" validIf="startTime &lt; endTime"/>
            <field name="endTime" colSpan="2" onChange="action-time-card-line-record-compute-duration" validIf="startTime &lt; endTime"/>
            <field name="duration" colSpan="2"/>
            <spacer/>
            <field name="leaveLine" onSelect="action-time-card-line-attrs-leaveline-domain" hidden="true" showIf="typeSelect == 'absence'" grid-view="leave-line-grid" form-view="leave-line-form"/>
            <field name="leaveRequest" showIf="leaveRequest &amp;&amp; typeSelect == 'absence'" grid-view="leave-request-grid" form-view="leave-request-form"/>
            <field name="comments" colSpan="12" widget="html"/>
            <spacer/>
            <panel title="Remplacements" showIf="(typeSelect == 'extra' &amp;&amp; isSubstitution) || typeSelect == 'absence'" colSpan="12">
                <field name="absenceTimeCardLine" showIf="typeSelect == 'extra' &amp;&amp; isSubstitution" grid-view="time-card-line-grid" form-view="time-card-line-form"/>
                <panel-related field="substitutionTimeCardLineList" readonly="true" showIf="typeSelect == 'absence'" canNew="false" colSpan="12" grid-view="time-card-line-grid" form-view="time-card-line-form"/>
                <button name="addSubstitution" title="Ajouter un remplacement" css="btn-custom text-left" icon="fa-plus" onClick="save,action-time-card-line-view-add-substitution" showIf="typeSelect == 'absence'"/>

                <field name="isSubstitution" hidden="true"/>
            </panel>
        </panel>
    </form>

    <form name="time-card-line-substitution-wizard-form" title="Assistant remplacements" model="com.axelor.apps.base.db.Wizard"
          onNew="action-time-card-line-method-set-wizard-defaults">
        <panel>
            <field name="$startDate" title="Date de début" widget="Date"/>
            <field name="$endDate" title="Date de fin" widget="Date"/>
            <field name="$employeeToReplace" title="Employé à remplacer" widget="ManyToOne" target="com.axelor.apps.hr.db.Employee" readonly="true"/>
            <field name="$employeeReplacing" title="Employé remplaçant" widget="ManyToOne" target="com.axelor.apps.hr.db.Employee"/>
            <field name="$projects" title="Chantiers" widget="TagSelect" target="com.axelor.apps.project.db.Project" canNew="false" colSpan="12"/>
            <button name="validate" title="Valider" onClick="action-time-card-line-method-generate-extra-tcl" colOffset="3"/>
        </panel>
    </form>

    <calendar name="time-card-line-calendar" title="Pointage" model="com.axelor.apps.timecard.db.TimeCardLine"
              eventStart="startDateTime" eventStop="endDateTime" colorBy="typeSelect" editable="true">
        <field name="project"/>
        <field name="typeSelect"/>
    </calendar>

    <action-method name="action-time-card-line-method-set-defaults">
        <call class="com.axelor.apps.timecard.web.TimeCardLineController" method="setDefaults"/>
    </action-method>

    <action-method name="action-time-card-line-method-set-wizard-defaults">
        <call class="com.axelor.apps.timecard.web.TimeCardLineController" method="setWizardDefaults"/>
    </action-method>

    <action-method name="action-time-card-line-method-generate-extra-tcl">
        <call class="com.axelor.apps.timecard.web.TimeCardLineController" method="generateExtraTCL"/>
    </action-method>

    <action-attrs name="action-time-card-line-attrs-leaveline-domain">
        <attribute for="leaveLine" name="domain" expr="eval: &quot; self.employee.id = ${__this__.employee?.id} &quot;"/>
    </action-attrs>

    <action-record name="action-time-card-line-record-compute-duration" model="com.axelor.apps.timecard.db.TimeCardLine">
        <field name="duration" expr="eval: java.time.Duration.between(startTime, endTime).toMinutes() / 60"/>
    </action-record>

    <action-record name="action-time-card-line-record-get-week-day" model="com.axelor.apps.timecard.db.TimeCardLine">
        <field name="weekDay" expr="eval: date.getDayOfWeek().getValue()"/>
    </action-record>

    <action-view name="action-time-card-line-view-add-substitution" title="Ligne de remplacement" model="com.axelor.apps.timecard.db.TimeCardLine">
        <view type="form" name="time-card-line-form"/>
        <view-param name="popup" value="reload"/>
        <context name="_projectId" expr="eval: project?.id"/>
        <context name="_isSubstitution" expr="eval: true"/>
    </action-view>

</object-views>
